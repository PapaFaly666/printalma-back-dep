<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Filtres Avanc√©s - API Produits</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .filters-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .filter-group { 
            display: inline-block;
            margin: 10px;
            vertical-align: top;
        }
        .filter-group label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: bold;
            color: #333;
        }
        select, input, button { 
            padding: 8px; 
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            cursor: pointer;
            border-radius: 5px;
        }
        button:hover { background: #0056b3; }
        button.clear { background: #6c757d; }
        button.clear:hover { background: #545b62; }
        
        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .results { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            background: #f9f9f9;
            border-radius: 5px;
        }
        .success { 
            border-color: #28a745; 
            background: #d4edda; 
        }
        .error { 
            border-color: #dc3545; 
            background: #f8d7da; 
        }
        
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .product-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .product-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .product-info {
            font-size: 0.9em;
            color: #666;
            margin: 5px 0;
        }
        .genre-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            margin: 5px 5px 5px 0;
        }
        .genre-HOMME { background: #007bff; color: white; }
        .genre-FEMME { background: #e83e8c; color: white; }
        .genre-BEBE { background: #28a745; color: white; }
        .genre-UNISEXE { background: #6c757d; color: white; }
        
        pre { 
            white-space: pre-wrap; 
            word-wrap: break-word; 
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-size: 0.9em;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .pagination {
            text-align: center;
            margin: 20px 0;
        }
        .pagination button {
            margin: 0 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Filtres Avanc√©s - API Produits</h1>
        
        <!-- Section Statistiques -->
        <div id="statsSection" class="stats-section">
            <div class="stat-card">
                <div class="stat-number" id="totalProducts">-</div>
                <div class="stat-label">Total Produits</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalGenres">-</div>
                <div class="stat-label">Genres Disponibles</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalCategories">-</div>
                <div class="stat-label">Cat√©gories</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="publishedCount">-</div>
                <div class="stat-label">Publi√©s</div>
            </div>
        </div>
        
        <!-- Section Filtres -->
        <div class="filters-section">
            <h3>üîç Filtres Avanc√©s</h3>
            
            <div class="filter-group">
                <label for="genreFilter">Genre :</label>
                <select id="genreFilter">
                    <option value="">Tous les genres</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="categoryFilter">Cat√©gorie :</label>
                <select id="categoryFilter">
                    <option value="">Toutes les cat√©gories</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="statusFilter">Statut :</label>
                <select id="statusFilter">
                    <option value="">Tous les statuts</option>
                    <option value="PUBLISHED">Publi√©</option>
                    <option value="DRAFT">Brouillon</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="typeFilter">Type de produit :</label>
                <select id="typeFilter">
                    <option value="">Tous les types</option>
                    <option value="true">Produits pr√™ts</option>
                    <option value="false">Mockups</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="searchFilter">Recherche :</label>
                <input type="text" id="searchFilter" placeholder="Nom du produit...">
            </div>
            
            <div class="filter-group">
                <label for="limitFilter">Limite :</label>
                <select id="limitFilter">
                    <option value="10">10</option>
                    <option value="20" selected>20</option>
                    <option value="50">50</option>
                </select>
            </div>
            
            <div style="margin-top: 15px;">
                <button onclick="applyFilters()">üîç Appliquer Filtres</button>
                <button class="clear" onclick="clearFilters()">üóëÔ∏è Effacer</button>
                <button onclick="loadFilterOptions()">üîÑ Recharger Options</button>
            </div>
        </div>
        
        <!-- Section R√©sultats -->
        <div id="resultsSection">
            <div id="loading" class="loading" style="display: none;">
                ‚è≥ Chargement des produits...
            </div>
            
            <div id="results" class="results" style="display: none;">
                <h3>R√©sultats</h3>
                <div id="resultsSummary"></div>
                <div id="productsGrid" class="product-grid"></div>
                <div id="pagination" class="pagination"></div>
            </div>
            
            <div id="rawResponse" class="results" style="display: none;">
                <h3>R√©ponse Brute (JSON)</h3>
                <pre id="rawContent"></pre>
            </div>
        </div>
        
        <!-- Section Tests API -->
        <div class="filters-section">
            <h3>üß™ Tests API Rapides</h3>
            <button onclick="testGenresEndpoint()">Test /filters/genres</button>
            <button onclick="testCategoriesEndpoint()">Test /filters/categories</button>
            <button onclick="testStatsEndpoint()">Test /filters/stats</button>
            <button onclick="testHommeProducts()">Produits HOMME</button>
            <button onclick="testFemmeProducts()">Produits FEMME</button>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3004';
        let currentOffset = 0;
        let currentLimit = 20;
        let currentFilters = {};

        // Charger les donn√©es initiales
        document.addEventListener('DOMContentLoaded', function() {
            loadFilterOptions();
            loadStats();
        });

        // Charger les options de filtres
        async function loadFilterOptions() {
            try {
                // Charger les genres
                const genresResponse = await fetch(`${API_BASE}/products/filters/genres`);
                const genresData = await genresResponse.json();
                
                const genreSelect = document.getElementById('genreFilter');
                genreSelect.innerHTML = '<option value="">Tous les genres</option>';
                
                if (genresData.success) {
                    genresData.genres.forEach(genre => {
                        const option = document.createElement('option');
                        option.value = genre.genre;
                        option.textContent = `${genre.label} (${genre.count})`;
                        genreSelect.appendChild(option);
                    });
                    
                    document.getElementById('totalGenres').textContent = genresData.genres.length;
                }

                // Charger les cat√©gories
                const categoriesResponse = await fetch(`${API_BASE}/products/filters/categories`);
                const categoriesData = await categoriesResponse.json();
                
                const categorySelect = document.getElementById('categoryFilter');
                categorySelect.innerHTML = '<option value="">Toutes les cat√©gories</option>';
                
                if (categoriesData.success) {
                    categoriesData.categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.name;
                        option.textContent = `${category.name} (${category.productCount})`;
                        categorySelect.appendChild(option);
                    });
                    
                    document.getElementById('totalCategories').textContent = categoriesData.categories.length;
                }

            } catch (error) {
                console.error('Erreur lors du chargement des options:', error);
            }
        }

        // Charger les statistiques
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/products/filters/stats`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('totalProducts').textContent = data.stats.total;
                    document.getElementById('publishedCount').textContent = data.stats.byStatus.PUBLISHED || 0;
                }
            } catch (error) {
                console.error('Erreur lors du chargement des stats:', error);
            }
        }

        // Appliquer les filtres
        async function applyFilters(offset = 0) {
            const filters = {
                genre: document.getElementById('genreFilter').value,
                category: document.getElementById('categoryFilter').value,
                status: document.getElementById('statusFilter').value,
                isReadyProduct: document.getElementById('typeFilter').value,
                search: document.getElementById('searchFilter').value,
                limit: document.getElementById('limitFilter').value,
                offset: offset
            };

            // Nettoyer les filtres vides
            Object.keys(filters).forEach(key => {
                if (filters[key] === '' || filters[key] === null || filters[key] === undefined) {
                    delete filters[key];
                }
            });

            currentFilters = filters;
            currentOffset = offset;
            currentLimit = parseInt(filters.limit || 20);

            console.log('üîç Filtres appliqu√©s:', filters);

            // Afficher le loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('rawResponse').style.display = 'none';

            try {
                // Construire l'URL
                const params = new URLSearchParams();
                Object.entries(filters).forEach(([key, value]) => {
                    params.append(key, value);
                });

                const response = await fetch(`${API_BASE}/products?${params}`);
                const data = await response.json();

                // Cacher le loading
                document.getElementById('loading').style.display = 'none';

                if (response.ok) {
                    displayResults(data);
                    displayRawResponse(data);
                } else {
                    displayError(data);
                }

            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                console.error('Erreur lors de la r√©cup√©ration des produits:', error);
                displayError({ message: error.message });
            }
        }

        // Afficher les r√©sultats
        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            const summaryDiv = document.getElementById('resultsSummary');
            const gridDiv = document.getElementById('productsGrid');
            const paginationDiv = document.getElementById('pagination');

            resultsDiv.style.display = 'block';
            resultsDiv.className = 'results success';

            // R√©sum√©
            const total = data.pagination?.total || data.data?.length || 0;
            const showing = data.data?.length || 0;
            summaryDiv.innerHTML = `
                <p><strong>${showing}</strong> produits affich√©s sur <strong>${total}</strong> total(s)</p>
                ${Object.keys(currentFilters).length > 0 ? 
                    `<p>Filtres actifs: ${Object.entries(currentFilters).map(([k,v]) => `${k}="${v}"`).join(', ')}</p>` : 
                    ''
                }
            `;

            // Grille de produits
            gridDiv.innerHTML = '';
            if (data.data && data.data.length > 0) {
                data.data.forEach(product => {
                    const productCard = createProductCard(product);
                    gridDiv.appendChild(productCard);
                });
            } else {
                gridDiv.innerHTML = '<p>Aucun produit trouv√© avec ces filtres.</p>';
            }

            // Pagination
            if (data.pagination) {
                createPagination(data.pagination);
            }
        }

        // Cr√©er une carte produit
        function createProductCard(product) {
            const card = document.createElement('div');
            card.className = 'product-card';

            const genreBadge = product.genre ? 
                `<span class="genre-badge genre-${product.genre}">${product.genre}</span>` : '';

            const categories = product.categories?.map(cat => cat.name).join(', ') || 'Aucune';
            const sizes = product.sizes?.map(size => size.sizeName).join(', ') || 'Aucune';

            card.innerHTML = `
                <div class="product-title">${product.name}</div>
                <div class="product-info">Prix: ${product.price}‚Ç¨</div>
                <div class="product-info">Stock: ${product.stock}</div>
                <div class="product-info">Statut: ${product.status}</div>
                <div class="product-info">Type: ${product.isReadyProduct ? 'Produit pr√™t' : 'Mockup'}</div>
                <div class="product-info">Cat√©gories: ${categories}</div>
                <div class="product-info">Tailles: ${sizes}</div>
                <div style="margin-top: 10px;">
                    ${genreBadge}
                    ${product.hasDelimitations ? '<span class="genre-badge genre-HOMME">D√©limitations</span>' : ''}
                    ${product.hasCustomDesigns ? '<span class="genre-badge genre-FEMME">Designs</span>' : ''}
                </div>
            `;

            return card;
        }

        // Cr√©er la pagination
        function createPagination(pagination) {
            const paginationDiv = document.getElementById('pagination');
            paginationDiv.innerHTML = '';

            if (pagination.total <= currentLimit) return;

            const totalPages = Math.ceil(pagination.total / currentLimit);
            const currentPage = Math.floor(currentOffset / currentLimit) + 1;

            // Bouton pr√©c√©dent
            if (currentPage > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.textContent = '‚Üê Pr√©c√©dent';
                prevBtn.onclick = () => applyFilters((currentPage - 2) * currentLimit);
                paginationDiv.appendChild(prevBtn);
            }

            // Num√©ros de pages
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.style.background = i === currentPage ? '#28a745' : '#007bff';
                pageBtn.onclick = () => applyFilters((i - 1) * currentLimit);
                paginationDiv.appendChild(pageBtn);
            }

            // Bouton suivant
            if (currentPage < totalPages) {
                const nextBtn = document.createElement('button');
                nextBtn.textContent = 'Suivant ‚Üí';
                nextBtn.onclick = () => applyFilters(currentPage * currentLimit);
                paginationDiv.appendChild(nextBtn);
            }
        }

        // Afficher la r√©ponse brute
        function displayRawResponse(data) {
            const rawDiv = document.getElementById('rawResponse');
            const contentDiv = document.getElementById('rawContent');
            
            rawDiv.style.display = 'block';
            contentDiv.textContent = JSON.stringify(data, null, 2);
        }

        // Afficher une erreur
        function displayError(error) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'block';
            resultsDiv.className = 'results error';
            resultsDiv.innerHTML = `<h3>Erreur</h3><p>${error.message || 'Erreur inconnue'}</p>`;
        }

        // Effacer les filtres
        function clearFilters() {
            document.getElementById('genreFilter').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('searchFilter').value = '';
            document.getElementById('limitFilter').value = '20';
            
            currentFilters = {};
            currentOffset = 0;
            
            document.getElementById('results').style.display = 'none';
            document.getElementById('rawResponse').style.display = 'none';
        }

        // Tests API rapides
        async function testGenresEndpoint() {
            try {
                const response = await fetch(`${API_BASE}/products/filters/genres`);
                const data = await response.json();
                displayRawResponse(data);
            } catch (error) {
                displayError(error);
            }
        }

        async function testCategoriesEndpoint() {
            try {
                const response = await fetch(`${API_BASE}/products/filters/categories`);
                const data = await response.json();
                displayRawResponse(data);
            } catch (error) {
                displayError(error);
            }
        }

        async function testStatsEndpoint() {
            try {
                const response = await fetch(`${API_BASE}/products/filters/stats`);
                const data = await response.json();
                displayRawResponse(data);
            } catch (error) {
                displayError(error);
            }
        }

        async function testHommeProducts() {
            document.getElementById('genreFilter').value = 'HOMME';
            await applyFilters();
        }

        async function testFemmeProducts() {
            document.getElementById('genreFilter').value = 'FEMME';
            await applyFilters();
        }
    </script>
</body>
</html> 