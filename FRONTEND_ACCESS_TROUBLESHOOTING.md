# üîß Guide de D√©pannage - Acc√®s Refus√© Frontend

## üö® Probl√®me : "Forbidden resource" (403) malgr√© une connexion SUPERADMIN

Ce guide vous aide √† diagnostiquer et r√©soudre les probl√®mes d'acc√®s refus√© dans le frontend.

## üîç Diagnostic Rapide

### √âtape 1 : V√©rifier l'authentification
```javascript
// Test d'authentification de base
const testAuth = async () => {
  try {
    const response = await fetch('/api/orders/test-auth', {
      credentials: 'include'
    });
    const result = await response.json();
    
    console.log('=== DIAGNOSTIC AUTHENTIFICATION ===');
    console.log('Status:', response.status);
    console.log('R√©ponse compl√®te:', result);
    console.log('Utilisateur:', result.data?.user);
    console.log('R√¥le utilisateur:', result.data?.userRole);
    console.log('ID utilisateur:', result.data?.userId);
    console.log('===================================');
    
    return result;
  } catch (error) {
    console.error('Erreur test auth:', error);
  }
};

// Ex√©cuter le test
testAuth();
```

### √âtape 2 : V√©rifier l'acc√®s admin
```javascript
// Test d'acc√®s admin
const testAdmin = async () => {
  try {
    const response = await fetch('/api/orders/test-admin', {
      credentials: 'include'
    });
    const result = await response.json();
    
    console.log('=== DIAGNOSTIC ACC√àS ADMIN ===');
    console.log('Status:', response.status);
    console.log('Succ√®s:', result.success);
    console.log('Message:', result.message);
    console.log('Donn√©es:', result.data);
    console.log('==============================');
    
    return result;
  } catch (error) {
    console.error('Erreur test admin:', error);
  }
};

// Ex√©cuter le test
testAdmin();
```

## üîß Solutions par Probl√®me

### Probl√®me 1 : Token JWT non envoy√©

**Sympt√¥mes :**
- Erreur 401 (Unauthorized)
- `req.user` est undefined

**Solutions :**

#### Solution A : V√©rifier les cookies
```javascript
// V√©rifier si le cookie auth_token existe
const checkCookie = () => {
  const cookies = document.cookie.split(';');
  const authCookie = cookies.find(cookie => cookie.trim().startsWith('auth_token='));
  
  console.log('=== V√âRIFICATION COOKIE ===');
  console.log('Tous les cookies:', document.cookie);
  console.log('Cookie auth_token:', authCookie);
  console.log('===========================');
  
  return authCookie;
};

checkCookie();
```

#### Solution B : Forcer l'inclusion des cookies
```javascript
// Toujours inclure credentials: 'include'
const apiCall = async (url, options = {}) => {
  return fetch(url, {
    ...options,
    credentials: 'include', // OBLIGATOIRE
    headers: {
      'Content-Type': 'application/json',
      ...options.headers
    }
  });
};
```

#### Solution C : Utiliser le header Authorization
```javascript
// Si les cookies ne marchent pas, utiliser le header
const getTokenFromStorage = () => {
  return localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token');
};

const apiCallWithHeader = async (url, options = {}) => {
  const token = getTokenFromStorage();
  
  return fetch(url, {
    ...options,
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json',
      ...options.headers
    }
  });
};
```

### Probl√®me 2 : Structure JWT incorrecte

**Sympt√¥mes :**
- `req.user.role` est undefined
- `req.user.sub` est undefined

**Solution : V√©rifier la structure du token**
```javascript
// D√©coder le token JWT pour v√©rifier sa structure
const decodeJWT = (token) => {
  try {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
      return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
    
    const payload = JSON.parse(jsonPayload);
    
    console.log('=== STRUCTURE TOKEN JWT ===');
    console.log('Payload complet:', payload);
    console.log('ID utilisateur (sub):', payload.sub);
    console.log('R√¥le (role):', payload.role);
    console.log('Email:', payload.email);
    console.log('Expiration:', new Date(payload.exp * 1000));
    console.log('===========================');
    
    return payload;
  } catch (error) {
    console.error('Erreur d√©codage JWT:', error);
  }
};

// Utiliser avec le token depuis le cookie ou localStorage
const token = getTokenFromStorage();
if (token) {
  decodeJWT(token);
}
```

### Probl√®me 3 : Probl√®me de CORS

**Sympt√¥mes :**
- Erreurs CORS dans la console
- Cookies non envoy√©s

**Solutions :**

#### Solution A : V√©rifier la configuration CORS backend
```javascript
// Le backend doit avoir cette configuration
/*
app.use(cors({
  origin: ['http://localhost:3000', 'http://localhost:3001'], // Vos domaines frontend
  credentials: true, // OBLIGATOIRE pour les cookies
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH'],
  allowedHeaders: ['Content-Type', 'Authorization']
}));
*/
```

#### Solution B : V√©rifier l'URL de l'API
```javascript
// Configuration des URLs
const API_CONFIG = {
  // En d√©veloppement
  development: 'http://localhost:3000',
  // En production
  production: 'https://votre-api.com'
};

const API_BASE_URL = API_CONFIG[process.env.NODE_ENV] || API_CONFIG.development;

console.log('URL API utilis√©e:', API_BASE_URL);
```

### Probl√®me 4 : Token expir√©

**Sympt√¥mes :**
- Erreur 401 apr√®s un certain temps
- Fonctionnait avant, plus maintenant

**Solution : V√©rifier l'expiration et renouveler**
```javascript
const checkTokenExpiration = () => {
  const token = getTokenFromStorage();
  if (!token) {
    console.log('Aucun token trouv√©');
    return false;
  }
  
  const payload = decodeJWT(token);
  if (!payload) return false;
  
  const now = Date.now() / 1000;
  const isExpired = payload.exp < now;
  
  console.log('=== V√âRIFICATION EXPIRATION ===');
  console.log('Token expire le:', new Date(payload.exp * 1000));
  console.log('Maintenant:', new Date());
  console.log('Token expir√©:', isExpired);
  console.log('===============================');
  
  if (isExpired) {
    // Rediriger vers la page de connexion
    window.location.href = '/login';
  }
  
  return !isExpired;
};

// V√©rifier avant chaque appel API
checkTokenExpiration();
```

## üõ†Ô∏è Outils de Diagnostic Complets

### Outil de diagnostic complet
```javascript
const fullDiagnostic = async () => {
  console.log('üîç D√âBUT DU DIAGNOSTIC COMPLET');
  console.log('================================');
  
  // 1. V√©rifier les cookies
  console.log('1. COOKIES:');
  checkCookie();
  
  // 2. V√©rifier le localStorage
  console.log('2. LOCAL STORAGE:');
  const token = getTokenFromStorage();
  console.log('Token en storage:', token ? 'Pr√©sent' : 'Absent');
  
  // 3. D√©coder le token si pr√©sent
  if (token) {
    console.log('3. STRUCTURE TOKEN:');
    decodeJWT(token);
    
    // 4. V√©rifier l'expiration
    console.log('4. EXPIRATION:');
    checkTokenExpiration();
  }
  
  // 5. Test d'authentification
  console.log('5. TEST AUTHENTIFICATION:');
  await testAuth();
  
  // 6. Test d'acc√®s admin
  console.log('6. TEST ACC√àS ADMIN:');
  await testAdmin();
  
  // 7. Test d'un endpoint prot√©g√©
  console.log('7. TEST ENDPOINT PROT√âG√â:');
  try {
    const response = await fetch('/api/orders/admin/all?page=1&limit=1', {
      credentials: 'include'
    });
    console.log('Status endpoint prot√©g√©:', response.status);
    const result = await response.json();
    console.log('R√©ponse:', result);
  } catch (error) {
    console.error('Erreur endpoint prot√©g√©:', error);
  }
  
  console.log('================================');
  console.log('üèÅ FIN DU DIAGNOSTIC');
};

// Ex√©cuter le diagnostic complet
fullDiagnostic();
```

### Fonction de reconnexion automatique
```javascript
const autoReconnect = async () => {
  try {
    // Essayer de se reconnecter avec les identifiants stock√©s
    const email = localStorage.getItem('user_email');
    const password = localStorage.getItem('user_password'); // ‚ö†Ô∏è Pas recommand√© en production
    
    if (!email || !password) {
      console.log('Identifiants non trouv√©s, redirection vers login');
      window.location.href = '/login';
      return;
    }
    
    const response = await fetch('/api/auth/login', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'include',
      body: JSON.stringify({ email, password })
    });
    
    if (response.ok) {
      console.log('Reconnexion r√©ussie');
      window.location.reload();
    } else {
      console.log('√âchec de la reconnexion');
      window.location.href = '/login';
    }
  } catch (error) {
    console.error('Erreur reconnexion:', error);
    window.location.href = '/login';
  }
};
```

## üîÑ Wrapper API avec Gestion d'Erreurs

```javascript
// Wrapper API robuste avec gestion d'erreurs
const apiWrapper = {
  async call(url, options = {}) {
    try {
      // V√©rifier l'expiration du token avant l'appel
      if (!checkTokenExpiration()) {
        throw new Error('Token expir√©');
      }
      
      const response = await fetch(url, {
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json'
        },
        ...options
      });
      
      // Gestion des erreurs HTTP
      if (response.status === 401) {
        console.log('Token invalide ou expir√©');
        localStorage.removeItem('auth_token');
        sessionStorage.removeItem('auth_token');
        window.location.href = '/login';
        return;
      }
      
      if (response.status === 403) {
        console.error('Acc√®s refus√© - V√©rifiez vos permissions');
        // Lancer le diagnostic
        await fullDiagnostic();
        throw new Error('Acc√®s refus√©');
      }
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || `Erreur HTTP ${response.status}`);
      }
      
      return await response.json();
      
    } catch (error) {
      console.error('Erreur API:', error);
      
      // Si c'est une erreur r√©seau, proposer de relancer
      if (error.name === 'TypeError' && error.message.includes('fetch')) {
        if (confirm('Erreur de connexion. Voulez-vous r√©essayer ?')) {
          return this.call(url, options);
        }
      }
      
      throw error;
    }
  },
  
  // M√©thodes sp√©cifiques
  async get(url) {
    return this.call(url, { method: 'GET' });
  },
  
  async post(url, data) {
    return this.call(url, {
      method: 'POST',
      body: JSON.stringify(data)
    });
  },
  
  async patch(url, data) {
    return this.call(url, {
      method: 'PATCH',
      body: JSON.stringify(data)
    });
  },
  
  async delete(url) {
    return this.call(url, { method: 'DELETE' });
  }
};

// Utilisation
const getOrders = async () => {
  try {
    const result = await apiWrapper.get('/api/orders/admin/all');
    console.log('Commandes:', result.data);
  } catch (error) {
    console.error('Erreur r√©cup√©ration commandes:', error);
  }
};
```

## üöÄ Script de Test Rapide

```javascript
// Script √† copier-coller dans la console du navigateur
(async function quickTest() {
  console.log('üöÄ TEST RAPIDE D\'ACC√àS');
  console.log('======================');
  
  // Test 1: Authentification
  try {
    const authResponse = await fetch('/api/orders/test-auth', { credentials: 'include' });
    const authResult = await authResponse.json();
    console.log('‚úÖ Auth Status:', authResponse.status);
    console.log('‚úÖ Auth Data:', authResult.data);
  } catch (e) {
    console.log('‚ùå Auth Error:', e.message);
  }
  
  // Test 2: Acc√®s admin
  try {
    const adminResponse = await fetch('/api/orders/test-admin', { credentials: 'include' });
    const adminResult = await adminResponse.json();
    console.log('‚úÖ Admin Status:', adminResponse.status);
    console.log('‚úÖ Admin Success:', adminResult.success);
  } catch (e) {
    console.log('‚ùå Admin Error:', e.message);
  }
  
  // Test 3: Endpoint r√©el
  try {
    const ordersResponse = await fetch('/api/orders/admin/all?page=1&limit=1', { credentials: 'include' });
    console.log('‚úÖ Orders Status:', ordersResponse.status);
    if (ordersResponse.ok) {
      const ordersResult = await ordersResponse.json();
      console.log('‚úÖ Orders Success:', ordersResult.success);
    }
  } catch (e) {
    console.log('‚ùå Orders Error:', e.message);
  }
  
  console.log('======================');
  console.log('üèÅ FIN DU TEST RAPIDE');
})();
```

## üìã Checklist de V√©rification

### ‚úÖ Avant de contacter le support :

1. **Cookies** : Le cookie `auth_token` est-il pr√©sent ?
2. **Token** : Le token JWT contient-il `sub` et `role` ?
3. **Expiration** : Le token n'est-il pas expir√© ?
4. **CORS** : Les appels API incluent-ils `credentials: 'include'` ?
5. **URL** : L'URL de l'API est-elle correcte ?
6. **R√¥le** : L'utilisateur a-t-il bien le r√¥le SUPERADMIN ?
7. **Tests** : Les endpoints de test fonctionnent-ils ?

### üîß Actions correctives :

1. **Vider le cache** du navigateur
2. **Se d√©connecter/reconnecter**
3. **V√©rifier la console** pour les erreurs
4. **Tester avec un autre navigateur**
5. **V√©rifier la configuration CORS** du backend

## üìû Informations √† fournir au support

Si le probl√®me persiste, fournissez ces informations :

```javascript
// Informations de debug √† copier
const debugInfo = {
  userAgent: navigator.userAgent,
  url: window.location.href,
  cookies: document.cookie,
  localStorage: { ...localStorage },
  sessionStorage: { ...sessionStorage },
  timestamp: new Date().toISOString()
};

console.log('=== INFORMATIONS DEBUG ===');
console.log(JSON.stringify(debugInfo, null, 2));
console.log('==========================');
```

Ce guide devrait r√©soudre 99% des probl√®mes d'acc√®s refus√© ! üéØ 