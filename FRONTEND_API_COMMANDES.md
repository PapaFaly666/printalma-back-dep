# üìã API Commandes Frontend - PrintAlma

## üéØ Vue d'Ensemble

Documentation compl√®te des endpoints de commandes pour l'√©quipe frontend. Tous les exemples incluent les formats exacts de donn√©es √† envoyer et recevoir.

## üîê Authentification

**Important :** Toutes les requ√™tes n√©cessitent une authentification par cookie `auth_token`.

```javascript
// Configuration fetch avec cookies
const fetchConfig = {
  credentials: 'include', // ‚≠ê ESSENTIEL pour envoyer les cookies
  headers: {
    'Content-Type': 'application/json'
  }
};
```

## üì¶ 1. Cr√©er une Commande (POST)

### üîó Endpoint
```
POST http://localhost:3004/orders
```

### üìù Format de Requ√™te

```javascript
const orderData = {
  shippingAddress: "123 Rue de la Paix, 75001 Paris, France",
  phoneNumber: "+33123456789",
  notes: "Livraison en point relais pr√©f√©r√©e", // Optionnel
  orderItems: [
    {
      productId: 1,
      quantity: 2,
      size: "M",
      color: "Rouge"
    },
    {
      productId: 3,
      quantity: 1,
      size: "L", 
      color: "Bleu"
    }
  ]
};

// Envoi de la requ√™te
const response = await fetch('http://localhost:3004/orders', {
  method: 'POST',
  credentials: 'include',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(orderData)
});
```

### ‚úÖ R√©ponse de Succ√®s (201)

```json
{
  "success": true,
  "message": "Commande cr√©√©e avec succ√®s",
  "data": {
    "id": 15,
    "orderNumber": "CMD20241127001",
    "status": "PENDING",
    "totalAmount": 89.99,
    "shippingAddress": "123 Rue de la Paix, 75001 Paris, France",
    "phoneNumber": "+33123456789",
    "notes": "Livraison en point relais pr√©f√©r√©e",
    "userId": 5,
    "userEmail": "client@example.com",
    "userFirstName": "Jean",
    "userLastName": "Dupont",
    "createdAt": "2024-11-27T14:30:00.000Z",
    "updatedAt": "2024-11-27T14:30:00.000Z",
    "orderItems": [
      {
        "id": 25,
        "orderId": 15,
        "productId": 1,
        "quantity": 2,
        "unitPrice": 29.99,
        "totalPrice": 59.98,
        "size": "M",
        "color": "Rouge",
        "product": {
          "id": 1,
          "name": "T-shirt Design Unique",
          "description": "T-shirt avec design personnalis√©",
          "price": 29.99,
          "imageUrl": "https://res.cloudinary.com/example/image/upload/v123/tshirt.jpg",
          "category": {
            "id": 1,
            "name": "V√™tements"
          }
        }
      },
      {
        "id": 26,
        "orderId": 15,
        "productId": 3,
        "quantity": 1,
        "unitPrice": 29.99,
        "totalPrice": 29.99,
        "size": "L",
        "color": "Bleu",
        "product": {
          "id": 3,
          "name": "Hoodie Premium",
          "description": "Sweat √† capuche de qualit√©",
          "price": 29.99,
          "imageUrl": "https://res.cloudinary.com/example/image/upload/v124/hoodie.jpg",
          "category": {
            "id": 1,
            "name": "V√™tements"
          }
        }
      }
    ]
  }
}
```

### ‚ùå Erreurs Possibles

#### Donn√©es invalides (400)
```json
{
  "success": false,
  "message": "Donn√©es de commande invalides",
  "errors": [
    "L'adresse de livraison est requise",
    "Le num√©ro de t√©l√©phone est invalide",
    "Au moins un article est requis"
  ]
}
```

#### Produit non disponible (400)
```json
{
  "success": false,
  "message": "Produit non disponible",
  "error": "Le produit avec l'ID 1 n'est pas disponible"
}
```

#### Non authentifi√© (401)
```json
{
  "message": "Unauthorized",
  "statusCode": 401
}
```

## üìã 2. Lister Mes Commandes (GET)

### üîó Endpoint
```
GET http://localhost:3004/orders/my-orders?page=1&limit=10
```

### üìù Param√®tres de Requ√™te

```javascript
const params = {
  page: 1,        // Num√©ro de page (d√©faut: 1)
  limit: 10,      // Nombre d'√©l√©ments par page (d√©faut: 10, max: 100)
  status: 'PENDING' // Optionnel: filtrer par statut
};

// Construction de l'URL
const url = new URL('http://localhost:3004/orders/my-orders');
Object.entries(params).forEach(([key, value]) => {
  if (value) url.searchParams.append(key, value);
});

const response = await fetch(url, {
  credentials: 'include'
});
```

### ‚úÖ R√©ponse de Succ√®s (200)

```json
{
  "success": true,
  "data": {
    "orders": [
      {
        "id": 15,
        "orderNumber": "CMD20241127001",
        "status": "PENDING",
        "totalAmount": 89.99,
        "shippingAddress": "123 Rue de la Paix, 75001 Paris, France",
        "phoneNumber": "+33123456789",
        "notes": "Livraison en point relais pr√©f√©r√©e",
        "createdAt": "2024-11-27T14:30:00.000Z",
        "updatedAt": "2024-11-27T14:30:00.000Z",
        "orderItems": [
          {
            "id": 25,
            "quantity": 2,
            "unitPrice": 29.99,
            "totalPrice": 59.98,
            "size": "M",
            "color": "Rouge",
            "product": {
              "id": 1,
              "name": "T-shirt Design Unique",
              "imageUrl": "https://res.cloudinary.com/example/image/upload/v123/tshirt.jpg"
            }
          }
        ]
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 10,
      "total": 25,
      "totalPages": 3,
      "hasNext": true,
      "hasPrevious": false
    }
  }
}
```

### üé≠ Statuts de Commande Possibles

```javascript
const ORDER_STATUSES = {
  'PENDING': 'En attente',
  'CONFIRMED': 'Confirm√©e',
  'PROCESSING': 'En traitement',
  'SHIPPED': 'Exp√©di√©e',
  'DELIVERED': 'Livr√©e',
  'CANCELLED': 'Annul√©e',
  'REJECTED': 'Rejet√©e'
};
```

## üëë 3. Lister Toutes les Commandes (Admin)

### üîó Endpoint
```
GET http://localhost:3004/orders/admin/all?page=1&limit=10&status=PENDING
```

### üìù Param√®tres de Requ√™te

```javascript
const adminParams = {
  page: 1,
  limit: 10,
  status: 'PENDING',    // Optionnel: filtrer par statut
  userId: 5,            // Optionnel: filtrer par utilisateur
  search: 'CMD20241127' // Optionnel: recherche par num√©ro de commande
};
```

### ‚úÖ R√©ponse Admin (200)

```json
{
  "success": true,
  "data": {
    "orders": [
      {
        "id": 15,
        "orderNumber": "CMD20241127001",
        "status": "PENDING",
        "totalAmount": 89.99,
        "shippingAddress": "123 Rue de la Paix, 75001 Paris, France",
        "phoneNumber": "+33123456789",
        "notes": "Livraison en point relais pr√©f√©r√©e",
        "userId": 5,
        "userEmail": "client@example.com",
        "userFirstName": "Jean",
        "userLastName": "Dupont",
        "createdAt": "2024-11-27T14:30:00.000Z",
        "updatedAt": "2024-11-27T14:30:00.000Z",
        "orderItems": [
          {
            "id": 25,
            "quantity": 2,
            "unitPrice": 29.99,
            "totalPrice": 59.98,
            "size": "M",
            "color": "Rouge",
            "product": {
              "id": 1,
              "name": "T-shirt Design Unique",
              "imageUrl": "https://res.cloudinary.com/example/image/upload/v123/tshirt.jpg",
              "category": {
                "id": 1,
                "name": "V√™tements"
              }
            }
          }
        ]
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 10,
      "total": 156,
      "totalPages": 16,
      "hasNext": true,
      "hasPrevious": false
    },
    "filters": {
      "status": "PENDING",
      "search": null,
      "userId": null
    }
  }
}
```

## üìä 4. D√©tails d'une Commande

### üîó Endpoint
```
GET http://localhost:3004/orders/:id
```

### üìù Exemple de Requ√™te

```javascript
const orderId = 15;
const response = await fetch(`http://localhost:3004/orders/${orderId}`, {
  credentials: 'include'
});
```

### ‚úÖ R√©ponse D√©taill√©e (200)

```json
{
  "success": true,
  "data": {
    "id": 15,
    "orderNumber": "CMD20241127001",
    "status": "PENDING",
    "totalAmount": 89.99,
    "shippingAddress": "123 Rue de la Paix, 75001 Paris, France",
    "phoneNumber": "+33123456789",
    "notes": "Livraison en point relais pr√©f√©r√©e",
    "userId": 5,
    "userEmail": "client@example.com",
    "userFirstName": "Jean",
    "userLastName": "Dupont",
    "createdAt": "2024-11-27T14:30:00.000Z",
    "updatedAt": "2024-11-27T14:30:00.000Z",
    "orderItems": [
      {
        "id": 25,
        "quantity": 2,
        "unitPrice": 29.99,
        "totalPrice": 59.98,
        "size": "M",
        "color": "Rouge",
        "product": {
          "id": 1,
          "name": "T-shirt Design Unique",
          "description": "T-shirt avec design personnalis√© de haute qualit√©",
          "price": 29.99,
          "imageUrl": "https://res.cloudinary.com/example/image/upload/v123/tshirt.jpg",
          "category": {
            "id": 1,
            "name": "V√™tements",
            "description": "V√™tements et accessoires"
          }
        }
      }
    ]
  }
}
```

### ‚ùå Commande Non Trouv√©e (404)

```json
{
  "success": false,
  "message": "Commande non trouv√©e",
  "statusCode": 404
}
```

## üîÑ 5. Modifier le Statut (Admin)

### üîó Endpoint
```
PUT http://localhost:3004/orders/:id/status
```

### üìù Format de Requ√™te

```javascript
const statusUpdate = {
  status: "CONFIRMED", // Nouveau statut
  notes: "Commande confirm√©e et pr√™te pour traitement" // Optionnel
};

const response = await fetch(`http://localhost:3004/orders/${orderId}/status`, {
  method: 'PUT',
  credentials: 'include',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(statusUpdate)
});
```

### ‚úÖ R√©ponse de Succ√®s (200)

```json
{
  "success": true,
  "message": "Statut de commande mis √† jour avec succ√®s",
  "data": {
    "id": 15,
    "orderNumber": "CMD20241127001",
    "previousStatus": "PENDING",
    "newStatus": "CONFIRMED",
    "totalAmount": 89.99,
    "updatedAt": "2024-11-27T15:45:00.000Z",
    "updatedBy": "admin@printalma.com"
  }
}
```

## üìà 6. Statistiques des Commandes (Admin)

### üîó Endpoint
```
GET http://localhost:3004/orders/admin/statistics
```

### ‚úÖ R√©ponse Statistiques (200)

```json
{
  "success": true,
  "data": {
    "overview": {
      "totalOrders": 156,
      "totalRevenue": 15847.50,
      "averageOrderValue": 101.58,
      "ordersToday": 8,
      "revenueToday": 456.80
    },
    "statusBreakdown": {
      "PENDING": 12,
      "CONFIRMED": 25,
      "PROCESSING": 18,
      "SHIPPED": 45,
      "DELIVERED": 89,
      "CANCELLED": 5,
      "REJECTED": 2
    },
    "recentActivity": [
      {
        "orderId": 15,
        "orderNumber": "CMD20241127001",
        "action": "Commande cr√©√©e",
        "timestamp": "2024-11-27T14:30:00.000Z",
        "customer": "Jean Dupont"
      }
    ],
    "topProducts": [
      {
        "productId": 1,
        "productName": "T-shirt Design Unique",
        "totalOrders": 45,
        "totalRevenue": 1349.55
      }
    ]
  }
}
```

## üîç 7. Recherche de Commandes (Admin)

### üîó Endpoint
```
GET http://localhost:3004/orders/admin/search?q=CMD20241127
```

### üìù Param√®tres de Recherche

```javascript
const searchParams = {
  q: 'CMD20241127',        // Recherche g√©n√©rale
  customerEmail: 'jean@',  // Recherche par email client
  customerName: 'Dupont',  // Recherche par nom client
  phone: '+33123',         // Recherche par t√©l√©phone
  dateFrom: '2024-11-01',  // Date de d√©but
  dateTo: '2024-11-30'     // Date de fin
};
```

## üé® 8. Formats d'Affichage Frontend

### üí∞ Formatage Prix

```javascript
const formatPrice = (price) => {
  return new Intl.NumberFormat('fr-FR', {
    style: 'currency',
    currency: 'EUR'
  }).format(price);
};

// Exemples
formatPrice(29.99); // "29,99 ‚Ç¨"
formatPrice(89.99); // "89,99 ‚Ç¨"
```

### üìÖ Formatage Dates

```javascript
const formatDate = (dateString) => {
  return new Date(dateString).toLocaleDateString('fr-FR', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
};

// Exemple
formatDate("2024-11-27T14:30:00.000Z"); // "27 novembre 2024 √† 15:30"
```

### üéØ Badges de Statut

```jsx
const StatusBadge = ({ status }) => {
  const getStatusConfig = (status) => {
    const configs = {
      'PENDING': { label: 'En attente', color: 'orange', icon: '‚è≥' },
      'CONFIRMED': { label: 'Confirm√©e', color: 'blue', icon: '‚úÖ' },
      'PROCESSING': { label: 'En traitement', color: 'purple', icon: '‚öôÔ∏è' },
      'SHIPPED': { label: 'Exp√©di√©e', color: 'cyan', icon: 'üöö' },
      'DELIVERED': { label: 'Livr√©e', color: 'green', icon: 'üì¶' },
      'CANCELLED': { label: 'Annul√©e', color: 'red', icon: '‚ùå' },
      'REJECTED': { label: 'Rejet√©e', color: 'gray', icon: 'üö´' }
    };
    return configs[status] || { label: status, color: 'gray', icon: '‚ùì' };
  };

  const config = getStatusConfig(status);
  
  return (
    <span className={`status-badge status-${config.color}`}>
      {config.icon} {config.label}
    </span>
  );
};
```

## üö® Gestion d'Erreurs

### üîß Fonction Utilitaire

```javascript
const handleApiResponse = async (response) => {
  if (!response.ok) {
    const errorData = await response.json().catch(() => ({}));
    
    switch (response.status) {
      case 400:
        throw new Error(errorData.message || 'Donn√©es invalides');
      case 401:
        // Rediriger vers login
        window.location.href = '/login';
        throw new Error('Non authentifi√©');
      case 403:
        throw new Error('Acc√®s refus√©');
      case 404:
        throw new Error('Ressource non trouv√©e');
      case 500:
        throw new Error('Erreur serveur');
      default:
        throw new Error(`Erreur ${response.status}`);
    }
  }
  
  return response.json();
};

// Utilisation
try {
  const data = await handleApiResponse(response);
  console.log('Succ√®s:', data);
} catch (error) {
  console.error('Erreur:', error.message);
  // Afficher message d'erreur √† l'utilisateur
}
```

## üéØ Exemple Complet d'Int√©gration

### üìù Service de Commandes

```javascript
// services/OrderService.js
class OrderService {
  constructor() {
    this.baseURL = process.env.REACT_APP_API_URL || 'http://localhost:3004';
  }

  async createOrder(orderData) {
    const response = await fetch(`${this.baseURL}/orders`, {
      method: 'POST',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(orderData)
    });

    return handleApiResponse(response);
  }

  async getMyOrders(page = 1, limit = 10, status = null) {
    const params = new URLSearchParams({ page, limit });
    if (status) params.append('status', status);

    const response = await fetch(`${this.baseURL}/orders/my-orders?${params}`, {
      credentials: 'include'
    });

    return handleApiResponse(response);
  }

  async getOrderDetails(orderId) {
    const response = await fetch(`${this.baseURL}/orders/${orderId}`, {
      credentials: 'include'
    });

    return handleApiResponse(response);
  }

  // M√©thodes admin
  async getAllOrders(page = 1, limit = 10, filters = {}) {
    const params = new URLSearchParams({ page, limit });
    Object.entries(filters).forEach(([key, value]) => {
      if (value) params.append(key, value);
    });

    const response = await fetch(`${this.baseURL}/orders/admin/all?${params}`, {
      credentials: 'include'
    });

    return handleApiResponse(response);
  }

  async updateOrderStatus(orderId, status, notes = '') {
    const response = await fetch(`${this.baseURL}/orders/${orderId}/status`, {
      method: 'PUT',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ status, notes })
    });

    return handleApiResponse(response);
  }

  async getStatistics() {
    const response = await fetch(`${this.baseURL}/orders/admin/statistics`, {
      credentials: 'include'
    });

    return handleApiResponse(response);
  }
}

export default new OrderService();
```

## üìû Support et Debugging

### üêõ Points de V√©rification

1. **Cookies** : `document.cookie` doit contenir `auth_token`
2. **CORS** : `credentials: 'include'` dans toutes les requ√™tes
3. **Headers** : `Content-Type: application/json` pour POST/PUT
4. **URL** : V√©rifier que le port 3004 est correct
5. **Erreurs** : Toujours g√©rer les codes d'erreur 400, 401, 403, 404, 500

### üîç Debug Console

```javascript
// Dans la console du navigateur
console.log('Cookies:', document.cookie);
console.log('Base URL:', process.env.REACT_APP_API_URL);

// Test rapide d'API
fetch('http://localhost:3004/orders/my-orders', { credentials: 'include' })
  .then(res => res.json())
  .then(data => console.log('Test API:', data))
  .catch(err => console.error('Erreur API:', err));
```

## ‚úÖ Checklist d'Int√©gration

- [ ] ‚úÖ Service OrderService cr√©√©
- [ ] ‚úÖ Gestion d'erreurs impl√©ment√©e
- [ ] ‚úÖ Formatage prix/dates configur√©
- [ ] ‚úÖ Composants StatusBadge cr√©√©s
- [ ] ‚úÖ Tests avec cookies fonctionnels
- [ ] ‚úÖ Pagination g√©r√©e
- [ ] ‚úÖ WebSocket int√©gr√© pour notifications temps r√©el

**Votre int√©gration API commandes est pr√™te ! üöÄ** 