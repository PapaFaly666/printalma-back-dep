<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèÜ Test Best Sellers API</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            border-radius: 10px;
            color: white;
        }
        .filters-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid #007bff;
        }
        .filter-group { 
            display: inline-block;
            margin: 10px;
            vertical-align: top;
        }
        .filter-group label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: bold;
            color: #333;
        }
        select, input, button { 
            padding: 10px; 
            margin: 5px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        button { 
            background: linear-gradient(135deg, #007bff, #0056b3); 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            cursor: pointer;
            border-radius: 8px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.3);
        }
        button.test-btn { background: linear-gradient(135deg, #28a745, #20c997); }
        button.clear { background: linear-gradient(135deg, #6c757d, #495057); }
        
        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .results { 
            margin: 20px 0; 
            padding: 20px; 
            border: 2px solid #ddd; 
            background: #f9f9f9;
            border-radius: 10px;
        }
        .success { 
            border-color: #28a745; 
            background: #d4edda; 
        }
        .error { 
            border-color: #dc3545; 
            background: #f8d7da; 
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .product-card {
            border: 2px solid #ddd;
            border-radius: 12px;
            padding: 20px;
            background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        .product-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #ff6b6b, #feca57);
        }
        .product-rank {
            position: absolute;
            top: 15px;
            right: 15px;
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }
        .product-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
            padding-right: 60px;
        }
        .product-info {
            font-size: 0.9em;
            color: #666;
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
        }
        .product-info strong {
            color: #333;
        }
        .vendor-info {
            background: #e9ecef;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .design-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .categories-tags {
            margin: 10px 0;
        }
        .category-tag {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin: 2px;
        }
        .colors-preview {
            display: flex;
            gap: 5px;
            margin: 10px 0;
        }
        .color-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #ddd;
        }
        
        pre { 
            white-space: pre-wrap; 
            word-wrap: break-word; 
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            font-size: 0.85em;
            max-height: 400px;
            overflow-y: auto;
            border-left: 4px solid #007bff;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.2em;
        }
        .loading::before {
            content: "‚è≥";
            font-size: 2em;
            display: block;
            margin-bottom: 10px;
        }
        
        .pagination {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .pagination button {
            margin: 0 5px;
        }
        
        .quick-tests {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÜ Test Best Sellers API</h1>
            <p>Endpoint: <code>http://localhost:3004/public/best-sellers</code></p>
        </div>
        
        <!-- Section Statistiques -->
        <div id="statsSection" class="stats-section">
            <div class="stat-card">
                <div class="stat-number" id="totalBestSellers">-</div>
                <div class="stat-label">Best Sellers</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalVendors">-</div>
                <div class="stat-label">Vendeurs</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalCategories">-</div>
                <div class="stat-label">Cat√©gories</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgRating">-</div>
                <div class="stat-label">Note Moyenne</div>
            </div>
        </div>
        
        <!-- Section Filtres -->
        <div class="filters-section">
            <h3>üéØ Filtres et Options</h3>
            
            <div class="filter-group">
                <label for="limitFilter">Limite :</label>
                <select id="limitFilter">
                    <option value="5">5</option>
                    <option value="10">10</option>
                    <option value="20" selected>20</option>
                    <option value="50">50</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="categoryFilter">Cat√©gorie :</label>
                <select id="categoryFilter">
                    <option value="">Toutes</option>
                    <option value="T-shirts">T-shirts</option>
                    <option value="Hoodies">Hoodies</option>
                    <option value="Polos">Polos</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="vendorFilter">ID Vendeur :</label>
                <input type="number" id="vendorFilter" placeholder="Ex: 1">
            </div>
            
            <div class="filter-group">
                <label for="minSalesFilter">Min. Ventes :</label>
                <input type="number" id="minSalesFilter" placeholder="Ex: 5" value="1">
            </div>
            
            <div style="margin-top: 15px;">
                <button onclick="loadBestSellers()">üîç Charger Best Sellers</button>
                <button class="clear" onclick="clearFilters()">üóëÔ∏è Effacer</button>
                <button class="test-btn" onclick="loadStats()">üìä Stats</button>
            </div>
        </div>
        
        <!-- Tests Rapides -->
        <div class="filters-section">
            <h3>üß™ Tests Rapides</h3>
            <div class="quick-tests">
                <button onclick="testTop5()">Top 5</button>
                <button onclick="testByCategory()">Par Cat√©gorie</button>
                <button onclick="testByVendor()">Par Vendeur</button>
                <button onclick="testStats()">Statistiques</button>
                <button onclick="initTestData()">Init Data</button>
                <button onclick="testPagination()">Pagination</button>
            </div>
        </div>
        
        <!-- Section R√©sultats -->
        <div id="resultsSection">
            <div id="loading" class="loading" style="display: none;">
                Chargement des best-sellers...
            </div>
            
            <div id="results" class="results" style="display: none;">
                <h3>üèÜ Best Sellers</h3>
                <div id="resultsSummary"></div>
                <div id="productsGrid" class="products-grid"></div>
                <div id="pagination" class="pagination"></div>
            </div>
            
            <div id="rawResponse" class="results" style="display: none;">
                <h3>üìã R√©ponse JSON</h3>
                <pre id="rawContent"></pre>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3004';
        let currentOffset = 0;
        let currentLimit = 20;

        // Charger les statistiques au d√©marrage
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
        });

        // Charger les best-sellers
        async function loadBestSellers(offset = 0) {
            const limit = parseInt(document.getElementById('limitFilter').value);
            const category = document.getElementById('categoryFilter').value;
            const vendorId = document.getElementById('vendorFilter').value;
            const minSales = document.getElementById('minSalesFilter').value;

            const params = new URLSearchParams();
            params.append('limit', limit);
            params.append('offset', offset);
            if (category) params.append('category', category);
            if (vendorId) params.append('vendorId', vendorId);
            if (minSales) params.append('minSales', minSales);

            currentOffset = offset;
            currentLimit = limit;

            console.log('üîç Chargement best-sellers:', { limit, offset, category, vendorId, minSales });

            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('rawResponse').style.display = 'none';

            try {
                const response = await fetch(`${API_BASE}/public/best-sellers?${params}`);
                const data = await response.json();

                document.getElementById('loading').style.display = 'none';

                if (response.ok) {
                    displayResults(data);
                    displayRawResponse(data);
                    updateStats(data.stats);
                } else {
                    displayError(data);
                }

            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                console.error('Erreur:', error);
                displayError({ message: error.message });
            }
        }

        // Afficher les r√©sultats
        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            const summaryDiv = document.getElementById('resultsSummary');
            const gridDiv = document.getElementById('productsGrid');

            resultsDiv.style.display = 'block';
            resultsDiv.className = 'results success';

            // R√©sum√©
            const total = data.pagination?.total || 0;
            const showing = data.data?.length || 0;
            summaryDiv.innerHTML = `
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <strong>${showing}</strong> best-sellers affich√©s sur <strong>${total}</strong> total(s)
                    ${data.stats ? `| <strong>${data.stats.vendorsCount}</strong> vendeurs | <strong>${data.stats.categoriesCount}</strong> cat√©gories` : ''}
                </div>
            `;

            // Grille de produits
            gridDiv.innerHTML = '';
            if (data.data && data.data.length > 0) {
                data.data.forEach(product => {
                    const productCard = createProductCard(product);
                    gridDiv.appendChild(productCard);
                });
            } else {
                gridDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><h3>ü§∑‚Äç‚ôÇÔ∏è Aucun best-seller trouv√©</h3><p>Essayez d\'ajuster vos filtres ou initialisez des donn√©es de test.</p></div>';
            }

            // Pagination
            if (data.pagination && data.pagination.total > currentLimit) {
                createPagination(data.pagination);
            }
        }

        // Cr√©er une carte produit
        function createProductCard(product) {
            const card = document.createElement('div');
            card.className = 'product-card';

            // Informations vendeur
            const vendorName = `${product.vendor.firstName} ${product.vendor.lastName}`;
            
            // Cat√©gories
            const categories = product.baseProduct.categories.map(cat => 
                `<span class="category-tag">${cat.name}</span>`
            ).join('');

            // Couleurs disponibles
            const colors = product.baseProduct.colorVariations.map(color => 
                `<div class="color-dot" style="background-color: ${color.colorCode}" title="${color.name}"></div>`
            ).join('');

            // Informations design
            const designInfo = product.designCloudinaryUrl ? `
                <div class="design-info">
                    <strong>üé® Design:</strong> ${product.designWidth}x${product.designHeight}px, ${product.designFormat}<br>
                    <strong>üìè √âchelle:</strong> ${product.designScale || 0.6} | <strong>üìç Position:</strong> ${product.designPositioning || 'CENTER'}
                </div>
            ` : '<div style="padding: 10px; background: #f8f9fa; border-radius: 8px; color: #666;">Aucun design personnalis√©</div>';

            card.innerHTML = `
                <div class="product-rank">#${product.bestSellerRank}</div>
                <div class="product-title">${product.name}</div>
                
                <div class="product-info">
                    <span><strong>üí∞ Prix:</strong> ${product.price}‚Ç¨</span>
                    <span><strong>üìä Ventes:</strong> ${product.salesCount}</span>
                </div>
                
                <div class="product-info">
                    <span><strong>üíé CA Total:</strong> ${product.totalRevenue.toLocaleString()}‚Ç¨</span>
                    <span><strong>üëÄ Vues:</strong> ${product.viewsCount}</span>
                </div>
                
                ${product.averageRating ? `
                <div class="product-info">
                    <span><strong>‚≠ê Note:</strong> ${product.averageRating}/5</span>
                    <span><strong>üìÖ Derni√®re vente:</strong> ${new Date(product.lastSaleDate).toLocaleDateString()}</span>
                </div>
                ` : ''}
                
                <div class="vendor-info">
                    <strong>üè™ Vendeur:</strong> ${vendorName}<br>
                    ${product.vendor.businessName ? `<strong>Entreprise:</strong> ${product.vendor.businessName}<br>` : ''}
                    <strong>üìß Email:</strong> ${product.vendor.email}
                </div>
                
                ${designInfo}
                
                <div class="product-info">
                    <span><strong>üì¶ Produit de base:</strong> ${product.baseProduct.name}</span>
                    <span><strong>üë• Genre:</strong> ${product.baseProduct.genre}</span>
                </div>
                
                <div class="categories-tags">
                    ${categories}
                </div>
                
                <div class="colors-preview">
                    <strong>üé® Couleurs:</strong>
                    ${colors}
                </div>
                
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; font-size: 0.8em; color: #666;">
                    <strong>Cr√©√©:</strong> ${new Date(product.createdAt).toLocaleDateString()}
                    ${product.baseProduct.colorVariations[0]?.images?.length ? ` | <strong>Images:</strong> ${product.baseProduct.colorVariations[0].images.length}` : ''}
                    ${product.baseProduct.colorVariations[0]?.images[0]?.delimitations?.length ? ` | <strong>D√©limitations:</strong> ${product.baseProduct.colorVariations[0].images[0].delimitations.length}` : ''}
                </div>
            `;

            return card;
        }

        // Cr√©er la pagination
        function createPagination(pagination) {
            const paginationDiv = document.getElementById('pagination');
            paginationDiv.innerHTML = '';

            const totalPages = Math.ceil(pagination.total / currentLimit);
            const currentPage = Math.floor(currentOffset / currentLimit) + 1;

            paginationDiv.innerHTML = `
                <div style="margin-bottom: 15px;">
                    Page ${currentPage} sur ${totalPages} (${pagination.total} r√©sultats)
                </div>
            `;

            // Bouton pr√©c√©dent
            if (currentPage > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.textContent = '‚Üê Pr√©c√©dent';
                prevBtn.onclick = () => loadBestSellers((currentPage - 2) * currentLimit);
                paginationDiv.appendChild(prevBtn);
            }

            // Num√©ros de pages
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.style.background = i === currentPage ? 
                    'linear-gradient(135deg, #28a745, #20c997)' : 
                    'linear-gradient(135deg, #007bff, #0056b3)';
                pageBtn.onclick = () => loadBestSellers((i - 1) * currentLimit);
                paginationDiv.appendChild(pageBtn);
            }

            // Bouton suivant
            if (currentPage < totalPages) {
                const nextBtn = document.createElement('button');
                nextBtn.textContent = 'Suivant ‚Üí';
                nextBtn.onclick = () => loadBestSellers(currentPage * currentLimit);
                paginationDiv.appendChild(nextBtn);
            }
        }

        // Afficher la r√©ponse JSON
        function displayRawResponse(data) {
            const rawDiv = document.getElementById('rawResponse');
            const contentDiv = document.getElementById('rawContent');
            
            rawDiv.style.display = 'block';
            contentDiv.textContent = JSON.stringify(data, null, 2);
        }

        // Afficher les erreurs
        function displayError(error) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'block';
            resultsDiv.className = 'results error';
            resultsDiv.innerHTML = `<h3>‚ùå Erreur</h3><p>${error.message || 'Erreur inconnue'}</p>`;
        }

        // Charger les statistiques
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/public/best-sellers/stats`);
                const data = await response.json();
                
                if (data.success && data.stats) {
                    updateStats(data.stats);
                }
            } catch (error) {
                console.error('Erreur stats:', error);
            }
        }

        // Mettre √† jour les statistiques
        function updateStats(stats) {
            if (stats) {
                document.getElementById('totalBestSellers').textContent = stats.totalBestSellers || 0;
                document.getElementById('totalVendors').textContent = stats.vendorsCount || 0;
                document.getElementById('totalCategories').textContent = stats.categoriesCount || 0;
                document.getElementById('avgRating').textContent = '4.2'; // Simul√©
            }
        }

        // Effacer les filtres
        function clearFilters() {
            document.getElementById('limitFilter').value = '20';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('vendorFilter').value = '';
            document.getElementById('minSalesFilter').value = '1';
            
            document.getElementById('results').style.display = 'none';
            document.getElementById('rawResponse').style.display = 'none';
        }

        // Tests rapides
        async function testTop5() {
            document.getElementById('limitFilter').value = '5';
            await loadBestSellers();
        }

        async function testByCategory() {
            document.getElementById('categoryFilter').value = 'T-shirts';
            await loadBestSellers();
        }

        async function testByVendor() {
            document.getElementById('vendorFilter').value = '1';
            await loadBestSellers();
        }

        async function testStats() {
            await loadStats();
            alert('Statistiques recharg√©es !');
        }

        async function initTestData() {
            if (confirm('Initialiser des donn√©es de test ? (Cela peut prendre quelques secondes)')) {
                try {
                    // Simuler l'initialisation (en r√©alit√©, il faudrait appeler le script)
                    alert('Pour initialiser les donn√©es, ex√©cutez: node init-best-sellers-data.js');
                } catch (error) {
                    alert('Erreur: ' + error.message);
                }
            }
        }

        async function testPagination() {
            document.getElementById('limitFilter').value = '3';
            await loadBestSellers();
        }
    </script>
</body>
</html> 