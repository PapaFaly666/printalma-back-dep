# üéØ Guide Syst√®me Sophistiqu√© de Gestion des Cat√©gories

## üìã Vue d'ensemble

Ce guide documente le syst√®me sophistiqu√© de gestion des cat√©gories, sous-cat√©gories et variations avec synchronisation automatique et contraintes de suppression.

## ‚ú® Fonctionnalit√©s Cl√©s

### 1. **Synchronisation Automatique** üîÑ
Lorsqu'un admin modifie une cat√©gorie/sous-cat√©gorie, **tous les produits li√©s** se mettent √† jour automatiquement.

### 2. **Contraintes de Suppression** üö´
Impossible de supprimer une cat√©gorie si des produits y sont li√©s. Les produits doivent d'abord √™tre d√©plac√©s.

### 3. **Structure Hi√©rarchique** üìä
- **Niveau 0** : Cat√©gorie parent (ex: "T√©l√©phone")
- **Niveau 1** : Sous-cat√©gorie (ex: "Coque")
- **Niveau 2** : Variation (ex: "iPhone 13", "iPhone 14")

---

## üîß Backend - Impl√©mentation

### Structure Prisma (Many-to-Many)

```prisma
model Category {
  id          Int        @id @default(autoincrement())
  name        String
  description String?
  parentId    Int?
  level       Int        @default(0)
  order       Int        @default(0)

  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    Category[] @relation("CategoryHierarchy")
  products    Product[]  @relation("CategoryToProduct") // ‚úÖ Relation Many-to-Many

  @@unique([name, parentId], name: "unique_category_per_parent")
  @@map("categories")
}

model Product {
  id          Int        @id @default(autoincrement())
  name        String
  categories  Category[] @relation("CategoryToProduct") // ‚úÖ Relation Many-to-Many
  // ... autres champs
}
```

**üí° Point Cl√©** : La relation many-to-many via Prisma cr√©e automatiquement une table de jointure `_CategoryToProduct` qui g√®re la synchronisation.

---

## üöÄ API Endpoints Backend

### 1. Cr√©er une Cat√©gorie

**Endpoint** : `POST /categories`

**Body** :
```json
{
  "name": "T√©l√©phone",
  "description": "Accessoires t√©l√©phone",
  "parentId": null,
  "level": 0
}
```

**Response** :
```json
{
  "success": true,
  "message": "Cat√©gorie cr√©√©e avec succ√®s",
  "data": {
    "id": 1,
    "name": "T√©l√©phone",
    "description": "Accessoires t√©l√©phone",
    "level": 0,
    "parentId": null
  }
}
```

---

### 2. Mettre √† Jour une Cat√©gorie (avec Synchronisation)

**Endpoint** : `PATCH /categories/:id`

**Body** :
```json
{
  "name": "Smartphones",
  "description": "Accessoires smartphones"
}
```

**Response** :
```json
{
  "success": true,
  "message": "Cat√©gorie mise √† jour avec succ√®s (5 produit(s) synchronis√©(s))",
  "data": {
    "id": 1,
    "name": "Smartphones",
    "description": "Accessoires smartphones",
    "productCount": 5
  }
}
```

**üîÑ Synchronisation Automatique** :
- Prisma met √† jour automatiquement la relation via `_CategoryToProduct`
- Tous les produits li√©s affichent le nouveau nom instantan√©ment
- Le backend compte et affiche le nombre de produits synchronis√©s

**Code Backend** (`category.service.ts`) :
```typescript
async update(id: number, updateCategoryDto: UpdateCategoryDto) {
    const category = await this.findOne(id);

    // V√©rifier les doublons
    if (updateCategoryDto.name && updateCategoryDto.name.trim() !== category.name) {
        const existingCategory = await this.prisma.category.findFirst({
            where: {
                name: updateCategoryDto.name.trim(),
                parentId: category.parentId || null,
                id: { not: id }
            }
        });

        if (existingCategory) {
            throw new ConflictException({
                success: false,
                error: 'DUPLICATE_CATEGORY',
                message: `Une cat√©gorie avec le nom "${updateCategoryDto.name}" existe d√©j√†`
            });
        }
    }

    // Mettre √† jour la cat√©gorie
    const updatedCategory = await this.prisma.category.update({
        where: { id },
        data: {
            name: updateCategoryDto.name?.trim(),
            description: updateCategoryDto.description?.trim()
        },
        include: {
            parent: true,
            children: true,
            _count: { select: { products: true } }
        }
    });

    // üîÑ Compter les produits synchronis√©s
    if (updateCategoryDto.name && updateCategoryDto.name.trim() !== category.name) {
        const productsToUpdate = await this.prisma.product.findMany({
            where: {
                categories: { some: { id } }
            },
            select: { id: true }
        });

        console.log(`üîÑ Synchronisation: ${productsToUpdate.length} produit(s) li√©s`);
    }

    return {
        success: true,
        message: `Cat√©gorie mise √† jour avec succ√®s${updatedCategory._count.products > 0 ? ` (${updatedCategory._count.products} produit(s) synchronis√©(s))` : ''}`,
        data: {
            ...updatedCategory,
            productCount: updatedCategory._count.products
        }
    };
}
```

---

### 3. Supprimer une Cat√©gorie (avec Contraintes)

**Endpoint** : `DELETE /categories/:id`

**Sc√©nario 1 - Cat√©gorie SANS produits li√©s** :
```http
DELETE /categories/5
```

**Response** :
```json
{
  "success": true,
  "message": "Cat√©gorie supprim√©e avec succ√®s",
  "deletedCount": 1
}
```

**Sc√©nario 2 - Cat√©gorie AVEC produits li√©s** :
```http
DELETE /categories/1
```

**Response (Error 400)** :
```json
{
  "statusCode": 400,
  "message": "Impossible de supprimer la cat√©gorie car elle (ou ses sous-cat√©gories) est li√©e √† 5 produit(s). Veuillez d'abord supprimer ou d√©placer ces produits vers une autre cat√©gorie.",
  "error": "Bad Request"
}
```

**üö´ Contrainte de Suppression** :
- Le backend v√©rifie r√©cursivement tous les enfants de la cat√©gorie
- Compte le nombre total de produits li√©s (cat√©gorie + enfants)
- Bloque la suppression si des produits sont trouv√©s

**Code Backend** (`category.service.ts`) :
```typescript
async remove(id: number) {
    const category = await this.findOne(id);

    // R√©cup√©rer tous les IDs des enfants (r√©cursif)
    const childrenIds = await this.getAllChildrenIds(id);
    const allIds = [id, ...childrenIds];

    // üö´ V√©rifier si des produits sont li√©s
    const productsCount = await this.prisma.product.count({
        where: {
            categories: {
                some: { id: { in: allIds } }
            }
        }
    });

    if (productsCount > 0) {
        throw new BadRequestException(
            `Impossible de supprimer la cat√©gorie car elle (ou ses sous-cat√©gories) est li√©e √† ${productsCount} produit(s). ` +
            `Veuillez d'abord supprimer ou d√©placer ces produits vers une autre cat√©gorie.`
        );
    }

    // Suppression en cascade (enfants supprim√©s automatiquement)
    await this.prisma.category.delete({
        where: { id },
    });

    return {
        success: true,
        message: 'Cat√©gorie supprim√©e avec succ√®s',
        deletedCount: allIds.length
    };
}

private async getAllChildrenIds(parentId: number): Promise<number[]> {
    const children = await this.prisma.category.findMany({
        where: { parentId },
        select: { id: true }
    });

    let allIds: number[] = [];

    for (const child of children) {
        allIds.push(child.id);
        const subChildren = await this.getAllChildrenIds(child.id);
        allIds = [...allIds, ...subChildren];
    }

    return allIds;
}
```

---

### 4. D√©placer des Produits entre Cat√©gories

**Endpoint** : `PATCH /products/:productId/categories`

**Body** :
```json
{
  "categoryIds": [2, 5, 8]
}
```

**Response** :
```json
{
  "success": true,
  "message": "Cat√©gories du produit mises √† jour avec succ√®s",
  "data": {
    "id": 10,
    "name": "T-Shirt Premium",
    "categories": [
      { "id": 2, "name": "V√™tements" },
      { "id": 5, "name": "T-Shirts" },
      { "id": 8, "name": "Coton Bio" }
    ]
  }
}
```

**Code Backend** (`product.service.ts`) :
```typescript
async updateProductCategories(productId: number, categoryIds: number[]) {
    // V√©rifier que le produit existe
    const product = await this.prisma.product.findUnique({
        where: { id: productId }
    });

    if (!product) {
        throw new NotFoundException(`Produit avec ID ${productId} non trouv√©`);
    }

    // V√©rifier que toutes les cat√©gories existent
    const categories = await this.prisma.category.findMany({
        where: { id: { in: categoryIds } }
    });

    if (categories.length !== categoryIds.length) {
        throw new BadRequestException('Une ou plusieurs cat√©gories sont invalides');
    }

    // Mettre √† jour les cat√©gories du produit
    const updatedProduct = await this.prisma.product.update({
        where: { id: productId },
        data: {
            categories: {
                set: categoryIds.map(id => ({ id }))
            }
        },
        include: {
            categories: true
        }
    });

    return {
        success: true,
        message: 'Cat√©gories du produit mises √† jour avec succ√®s',
        data: updatedProduct
    };
}
```

---

## üé® Frontend - Int√©gration

### 1. Interface de Modification de Cat√©gorie

```typescript
import React, { useState } from 'react';
import axios from 'axios';

interface CategoryEditFormProps {
  category: {
    id: number;
    name: string;
    description: string;
    productCount: number;
  };
  onSuccess: () => void;
}

const CategoryEditForm: React.FC<CategoryEditFormProps> = ({ category, onSuccess }) => {
  const [formData, setFormData] = useState({
    name: category.name,
    description: category.description
  });
  const [loading, setLoading] = useState(false);
  const [message, setMessage] = useState('');

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);

    try {
      const response = await axios.patch(
        `http://localhost:3000/categories/${category.id}`,
        formData
      );

      // ‚úÖ Afficher le message de synchronisation
      setMessage(response.data.message); // "Cat√©gorie mise √† jour avec succ√®s (5 produit(s) synchronis√©(s))"

      setTimeout(() => {
        onSuccess();
      }, 2000);
    } catch (error: any) {
      if (error.response?.data?.error === 'DUPLICATE_CATEGORY') {
        setMessage(`Erreur: ${error.response.data.message}`);
      } else {
        setMessage('Erreur lors de la mise √† jour');
      }
    } finally {
      setLoading(false);
    }
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div>
        <label className="block text-sm font-medium mb-1">Nom de la cat√©gorie</label>
        <input
          type="text"
          value={formData.name}
          onChange={(e) => setFormData({ ...formData, name: e.target.value })}
          className="w-full px-3 py-2 border rounded"
          required
        />
      </div>

      <div>
        <label className="block text-sm font-medium mb-1">Description</label>
        <textarea
          value={formData.description}
          onChange={(e) => setFormData({ ...formData, description: e.target.value })}
          className="w-full px-3 py-2 border rounded"
          rows={3}
        />
      </div>

      {category.productCount > 0 && (
        <div className="bg-yellow-50 border border-yellow-200 rounded p-3">
          <p className="text-sm text-yellow-800">
            ‚ö†Ô∏è Cette cat√©gorie est li√©e √† {category.productCount} produit(s).
            Tous seront automatiquement mis √† jour.
          </p>
        </div>
      )}

      {message && (
        <div className={`p-3 rounded ${message.includes('Erreur') ? 'bg-red-50 text-red-800' : 'bg-green-50 text-green-800'}`}>
          {message}
        </div>
      )}

      <button
        type="submit"
        disabled={loading}
        className="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 disabled:opacity-50"
      >
        {loading ? 'Mise √† jour...' : 'Mettre √† jour'}
      </button>
    </form>
  );
};

export default CategoryEditForm;
```

---

### 2. Interface de Suppression de Cat√©gorie

```typescript
import React, { useState } from 'react';
import axios from 'axios';

interface CategoryDeleteButtonProps {
  category: {
    id: number;
    name: string;
    productCount: number;
  };
  onSuccess: () => void;
}

const CategoryDeleteButton: React.FC<CategoryDeleteButtonProps> = ({ category, onSuccess }) => {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [showConfirm, setShowConfirm] = useState(false);

  const handleDelete = async () => {
    setLoading(true);
    setError('');

    try {
      await axios.delete(`http://localhost:3000/categories/${category.id}`);
      onSuccess();
    } catch (error: any) {
      if (error.response?.status === 400) {
        // üö´ Contrainte de suppression
        setError(error.response.data.message);
      } else {
        setError('Erreur lors de la suppression');
      }
    } finally {
      setLoading(false);
      setShowConfirm(false);
    }
  };

  // Si la cat√©gorie a des produits, bloquer la suppression
  if (category.productCount > 0) {
    return (
      <div className="bg-red-50 border border-red-200 rounded p-3">
        <p className="text-sm text-red-800">
          üö´ Impossible de supprimer cette cat√©gorie car elle est li√©e √† {category.productCount} produit(s).
        </p>
        <p className="text-xs text-red-600 mt-1">
          Veuillez d'abord d√©placer les produits vers une autre cat√©gorie.
        </p>
      </div>
    );
  }

  return (
    <>
      <button
        onClick={() => setShowConfirm(true)}
        className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"
      >
        Supprimer
      </button>

      {showConfirm && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
          <div className="bg-white rounded-lg p-6 max-w-md">
            <h3 className="text-lg font-semibold mb-4">Confirmer la suppression</h3>
            <p className="mb-4">
              √ätes-vous s√ªr de vouloir supprimer la cat√©gorie "{category.name}" ?
            </p>

            {error && (
              <div className="bg-red-50 border border-red-200 rounded p-3 mb-4">
                <p className="text-sm text-red-800">{error}</p>
              </div>
            )}

            <div className="flex gap-2">
              <button
                onClick={() => setShowConfirm(false)}
                className="flex-1 px-4 py-2 border rounded hover:bg-gray-50"
              >
                Annuler
              </button>
              <button
                onClick={handleDelete}
                disabled={loading}
                className="flex-1 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 disabled:opacity-50"
              >
                {loading ? 'Suppression...' : 'Supprimer'}
              </button>
            </div>
          </div>
        </div>
      )}
    </>
  );
};

export default CategoryDeleteButton;
```

---

### 3. Interface de D√©placement de Produits

```typescript
import React, { useState, useEffect } from 'react';
import axios from 'axios';

interface ProductCategoryMoverProps {
  product: {
    id: number;
    name: string;
    categories: { id: number; name: string }[];
  };
  onSuccess: () => void;
}

const ProductCategoryMover: React.FC<ProductCategoryMoverProps> = ({ product, onSuccess }) => {
  const [allCategories, setAllCategories] = useState<any[]>([]);
  const [selectedCategoryIds, setSelectedCategoryIds] = useState<number[]>(
    product.categories.map(c => c.id)
  );
  const [loading, setLoading] = useState(false);
  const [message, setMessage] = useState('');

  useEffect(() => {
    fetchCategories();
  }, []);

  const fetchCategories = async () => {
    try {
      const response = await axios.get('http://localhost:3000/categories/hierarchy');
      setAllCategories(response.data);
    } catch (error) {
      console.error('Erreur lors du chargement des cat√©gories', error);
    }
  };

  const handleToggleCategory = (categoryId: number) => {
    setSelectedCategoryIds(prev =>
      prev.includes(categoryId)
        ? prev.filter(id => id !== categoryId)
        : [...prev, categoryId]
    );
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (selectedCategoryIds.length === 0) {
      setMessage('Veuillez s√©lectionner au moins une cat√©gorie');
      return;
    }

    setLoading(true);

    try {
      const response = await axios.patch(
        `http://localhost:3000/products/${product.id}/categories`,
        { categoryIds: selectedCategoryIds }
      );

      setMessage(response.data.message);

      setTimeout(() => {
        onSuccess();
      }, 2000);
    } catch (error: any) {
      setMessage(error.response?.data?.message || 'Erreur lors du d√©placement');
    } finally {
      setLoading(false);
    }
  };

  const renderCategoryTree = (categories: any[], level = 0) => {
    return categories.map(category => (
      <div key={category.id} style={{ marginLeft: `${level * 20}px` }}>
        <label className="flex items-center gap-2 py-1">
          <input
            type="checkbox"
            checked={selectedCategoryIds.includes(category.id)}
            onChange={() => handleToggleCategory(category.id)}
            className="w-4 h-4"
          />
          <span>{category.name}</span>
          {category.productCount > 0 && (
            <span className="text-xs text-gray-500">({category.productCount})</span>
          )}
        </label>
        {category.subcategories && category.subcategories.length > 0 && (
          <div>
            {renderCategoryTree(category.subcategories, level + 1)}
          </div>
        )}
      </div>
    ));
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div>
        <h3 className="font-medium mb-2">Produit : {product.name}</h3>
        <p className="text-sm text-gray-600 mb-4">
          Cat√©gories actuelles : {product.categories.map(c => c.name).join(', ')}
        </p>
      </div>

      <div className="border rounded p-3 max-h-96 overflow-y-auto">
        <p className="font-medium mb-2">S√©lectionner les nouvelles cat√©gories :</p>
        {renderCategoryTree(allCategories)}
      </div>

      {message && (
        <div className={`p-3 rounded ${message.includes('Erreur') ? 'bg-red-50 text-red-800' : 'bg-green-50 text-green-800'}`}>
          {message}
        </div>
      )}

      <button
        type="submit"
        disabled={loading || selectedCategoryIds.length === 0}
        className="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 disabled:opacity-50"
      >
        {loading ? 'D√©placement...' : 'D√©placer le produit'}
      </button>
    </form>
  );
};

export default ProductCategoryMover;
```

---

## üß™ Sc√©narios de Test

### Sc√©nario 1 : Modification de Cat√©gorie avec Synchronisation

1. **Cr√©er une cat√©gorie** "T√©l√©phone"
2. **Cr√©er 5 produits mockup** li√©s √† "T√©l√©phone"
3. **Modifier le nom** de "T√©l√©phone" ‚Üí "Smartphones"
4. **V√©rifier** que tous les produits affichent "Smartphones"
5. **Backend log** : `üîÑ Synchronisation: 5 produit(s) li√©s √† la cat√©gorie "T√©l√©phone" ‚Üí "Smartphones"`

### Sc√©nario 2 : Tentative de Suppression Bloqu√©e

1. **Cr√©er une cat√©gorie** "V√™tements"
2. **Cr√©er 3 produits mockup** li√©s √† "V√™tements"
3. **Tenter de supprimer** la cat√©gorie "V√™tements"
4. **R√©sultat attendu** : Erreur 400 - "Impossible de supprimer la cat√©gorie car elle est li√©e √† 3 produit(s)"

### Sc√©nario 3 : D√©placement puis Suppression

1. **Cr√©er deux cat√©gories** : "T-Shirts" et "Polos"
2. **Cr√©er 5 produits** li√©s √† "T-Shirts"
3. **D√©placer les 5 produits** vers "Polos"
4. **Supprimer** la cat√©gorie "T-Shirts" (maintenant vide)
5. **R√©sultat attendu** : Suppression r√©ussie

### Sc√©nario 4 : Hi√©rarchie en Cascade

1. **Cr√©er structure** : T√©l√©phone > Coque > iPhone 13
2. **Cr√©er 2 produits** li√©s √† "iPhone 13"
3. **Tenter de supprimer** "T√©l√©phone" (parent)
4. **R√©sultat attendu** : Erreur - "Impossible de supprimer car ses sous-cat√©gories sont li√©es √† 2 produit(s)"

---

## üìä Diagramme de Flux

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    GESTION DES CAT√âGORIES                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
                 ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                 ‚îÇ  Admin modifie cat√©gorie ‚îÇ
                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
                 ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                 ‚îÇ Backend: PATCH /categories/:id ‚îÇ
                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
                 ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                 ‚îÇ V√©rifier doublon nom     ‚îÇ
                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ                   ‚îÇ
                 [Doublon]           [Pas de doublon]
                    ‚îÇ                   ‚îÇ
                    ‚ñº                   ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ Retour erreur 409‚îÇ  ‚îÇ Mettre √† jour DB ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                        ‚îÇ
                                        ‚ñº
                           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                           ‚îÇ Compter produits li√©s  ‚îÇ
                           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                        ‚îÇ
                                        ‚ñº
                           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                           ‚îÇ üîÑ Synchronisation auto ‚îÇ
                           ‚îÇ (via Prisma relation)  ‚îÇ
                           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                        ‚îÇ
                                        ‚ñº
                           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                           ‚îÇ Retour succ√®s + count  ‚îÇ
                           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                        ‚îÇ
                                        ‚ñº
                           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                           ‚îÇ Frontend: Afficher msg ‚îÇ
                           ‚îÇ "5 produit(s) sync"    ‚îÇ
                           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  SUPPRESSION DE CAT√âGORIE                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
                 ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                 ‚îÇ Admin tente suppression ‚îÇ
                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
                 ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                 ‚îÇ Backend: DELETE /categories/:id ‚îÇ
                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
                 ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                 ‚îÇ R√©cup√©rer enfants (r√©cursif) ‚îÇ
                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
                 ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                 ‚îÇ Compter produits li√©s   ‚îÇ
                 ‚îÇ (cat√©gorie + enfants)   ‚îÇ
                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ                   ‚îÇ
              [Produits li√©s]     [Aucun produit]
                    ‚îÇ                   ‚îÇ
                    ‚ñº                   ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ üö´ Retour erreur ‚îÇ  ‚îÇ Supprimer cat√©gorie ‚îÇ
         ‚îÇ 400 Bad Request  ‚îÇ  ‚îÇ + enfants (cascade) ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                        ‚îÇ
                                        ‚ñº
                           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                           ‚îÇ Retour succ√®s + count  ‚îÇ
                           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üéØ Points Cl√©s √† Retenir

### ‚úÖ Synchronisation Automatique
- **Prisma g√®re tout** via la relation many-to-many `_CategoryToProduct`
- Aucune migration de donn√©es manuelle n√©cessaire
- Les produits refl√®tent instantan√©ment les changements de cat√©gorie

### üö´ Contraintes de Suppression
- **V√©rification r√©cursive** : v√©rifie la cat√©gorie ET tous ses enfants
- **Message clair** : indique combien de produits bloquent la suppression
- **Solution** : d√©placer les produits avant suppression

### üîÑ Workflow Complet
1. Admin modifie cat√©gorie ‚Üí Backend synchronise ‚Üí Frontend affiche message
2. Admin tente suppression ‚Üí Backend v√©rifie produits ‚Üí Bloque ou autorise
3. Admin d√©place produits ‚Üí Backend met √† jour relations ‚Üí Suppression possible

---

## üìù Endpoints R√©sum√©s

| M√©thode | Endpoint | Description |
|---------|----------|-------------|
| `POST` | `/categories` | Cr√©er cat√©gorie |
| `GET` | `/categories` | Lister toutes les cat√©gories |
| `GET` | `/categories/hierarchy` | Arbre hi√©rarchique |
| `GET` | `/categories/:id` | D√©tails d'une cat√©gorie |
| `PATCH` | `/categories/:id` | **Modifier cat√©gorie (sync auto)** |
| `DELETE` | `/categories/:id` | **Supprimer (avec contrainte)** |
| `PATCH` | `/products/:id/categories` | **D√©placer produit** |

---

## üöÄ Conclusion

Ce syst√®me sophistiqu√© assure :
- ‚úÖ **Int√©grit√© des donn√©es** : Les produits restent toujours synchronis√©s
- ‚úÖ **S√©curit√©** : Impossible de supprimer accidentellement des cat√©gories utilis√©es
- ‚úÖ **Transparence** : Messages clairs indiquant le nombre de produits affect√©s
- ‚úÖ **Flexibilit√©** : D√©placement facile des produits entre cat√©gories

Le tout est g√©r√© **automatiquement par Prisma** avec un minimum de code backend ! üéâ
